<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ì§‘ ì°¨ ì–´ë””ìˆì§€? ğŸš—</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ìš°ë¦¬ì§‘ ì°¨ ì–´ë””ìˆì§€?">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%232563eb'/%3E%3Ctext x='96' y='130' font-size='80' fill='white' text-anchor='middle'%3EğŸš—%3C/text%3E%3C/svg%3E">

```
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
    }

    .container {
        max-width: 414px;
        margin: 0 auto;
        background: #f9fafb;
        min-height: 100vh;
        overflow-x: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: white;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .header p {
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .connection-status {
        padding: 10px 20px;
        font-size: 0.8rem;
        text-align: center;
    }

    .status-connected {
        background: #10b981;
        color: white;
    }

    .status-local {
        background: #f59e0b;
        color: white;
    }

    .main-content {
        padding: 20px;
    }

    .login-section {
        background: white;
        border-radius: 12px;
        padding: 30px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .login-section h2 {
        margin-bottom: 20px;
        color: #1f2937;
    }

    .login-tabs {
        display: flex;
        margin-bottom: 20px;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
    }

    .login-tab {
        flex: 1;
        padding: 10px;
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .login-tab.active {
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        font-weight: bold;
    }

    .car-list {
        margin-bottom: 30px;
    }

    .car-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .car-card:hover {
        transform: translateY(-2px);
    }

    .car-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .car-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #1f2937;
    }

    .car-status {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 20px;
        background: #ecfdf5;
        color: #065f46;
    }

    .parking-info {
        background: #f3f4f6;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .location-text {
        font-size: 1.1rem;
        color: #374151;
        margin-bottom: 5px;
    }

    .update-time {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .updated-by {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
    }

    .no-location {
        color: #9ca3af;
        font-style: italic;
    }

    .btn-group {
        display: flex;
        gap: 10px;
    }

    .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .add-car-btn {
        width: 100%;
        padding: 15px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .add-car-btn:hover {
        background: #059669;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
    }

    .modal h2 {
        margin-bottom: 20px;
        text-align: center;
        color: #1f2937;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #374151;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: #10b981;
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(300px);
        transition: transform 0.3s;
        z-index: 1001;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.error {
        background: #ef4444;
    }

    .settings {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .settings h3 {
        color: #374151;
        margin-bottom: 15px;
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .toggle {
        position: relative;
        width: 50px;
        height: 24px;
        background: #d1d5db;
        border-radius: 24px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle.active {
        background: #10b981;
    }

    .toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: left 0.3s;
    }

    .toggle.active::after {
        left: 28px;
    }

    .share-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
    }

    .share-code {
        font-family: monospace;
        font-size: 1.2rem;
        font-weight: bold;
        color: #1d4ed8;
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        margin: 8px 0;
        display: inline-block;
    }

    .logout-section {
        text-align: center;
        margin-top: 20px;
    }

    .btn-logout {
        background: #6b7280;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .update-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #059669;
        color: white;
        padding: 12px 20px;
        text-align: center;
        z-index: 10001;
        font-size: 0.9rem;
    }

    .refresh-btn {
        background: white;
        color: #059669;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        margin-left: 10px;
        font-weight: bold;
        cursor: pointer;
    }
</style>
```

</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸš— ìš°ë¦¬ì§‘ ì°¨ ì–´ë””ìˆì§€?</h1>
            <p>ì£¼ì°¨ ìœ„ì¹˜ë¥¼ ê°€ì¡±ê³¼ ì‹¤ì‹œê°„ ê³µìœ í•˜ì„¸ìš”</p>
        </header>

```
    <div class="connection-status" id="connectionStatus">
        ğŸ”Œ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...
    </div>

    <main class="main-content">
        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ì„¹ì…˜ -->
        <div class="login-section" id="loginSection">
            <h2>ğŸ”‘ ê·¸ë£¹ ì ‘ì†</h2>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('join')">ì°¸ì—¬í•˜ê¸°</button>
                <button class="login-tab" onclick="switchTab('create')">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
            </div>

            <!-- ì°¸ì—¬í•˜ê¸° í¼ -->
            <div id="joinForm">
                <div class="form-group">
                    <label for="joinCode">ê³µìœ  ì½”ë“œ</label>
                    <input type="text" id="joinCode" placeholder="ê³µìœ  ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label for="joinPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="joinPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="joinNickname">ë‚´ ì´ë¦„</label>
                    <input type="text" id="joinNickname" placeholder="ê°€ì¡±ë“¤ì´ ì•Œì•„ë³¼ ì´ë¦„" maxlength="10">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="joinGroup()">
                    ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°
                </button>
            </div>

            <!-- ìƒˆë¡œ ë§Œë“¤ê¸° í¼ -->
            <div id="createForm" style="display: none;">
                <div class="form-group">
                    <label for="createPassword">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label>
                    <input type="password" id="createPassword" placeholder="ê·¸ë£¹ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="createNickname">ë‚´ ì´ë¦„</label>
                    <input type="text" id="createNickname" placeholder="ê°€ì¡±ë“¤ì´ ì•Œì•„ë³¼ ì´ë¦„" maxlength="10">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="createGroup()">
                    ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ì•± ì„¹ì…˜ -->
        <div class="app-section" id="appSection" style="display: none;">
            <!-- ê³µìœ  ì •ë³´ -->
            <div class="share-info" id="shareInfo">
                <div>ğŸ”— ê·¸ë£¹ ê³µìœ  ì •ë³´</div>
                <div class="share-code" id="displayShareCode">LOADING...</div>
                <div style="font-size: 0.9rem; color: #6b7280;">ì´ ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°€ì¡±ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</div>
            </div>

            <button class="add-car-btn" onclick="showAddCarModal()">
                â• ìƒˆ ì°¨ëŸ‰ ì¶”ê°€
            </button>

            <div class="car-list" id="carList">
                <!-- ì°¨ëŸ‰ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="settings">
                <h3>âš™ï¸ ì„¤ì •</h3>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: bold;">ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ğŸ“±</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">ë°¤ 9ì‹œì— ì£¼ì°¨ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì•Œë¦¼</div>
                    </div>
                    <div class="toggle" id="notificationToggle" onclick="toggleNotification()"></div>
                </div>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: bold;">ê°•ì œ ìƒˆë¡œê³ ì¹¨</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            <button onclick="forceRefresh()" style="
                                background: #10b981; color: white; border: none; 
                                padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; 
                                margin-top: 4px; cursor: pointer;
                            ">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
                            <button onclick="clearCache()" style="
                                background: #ef4444; color: white; border: none; 
                                padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; 
                                margin-top: 4px; margin-left: 4px; cursor: pointer;
                            ">ìºì‹œ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="logout-section">
                <button class="btn-logout" onclick="logout()">ê·¸ë£¹ ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </main>
</div>

<!-- ì°¨ëŸ‰ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal" id="addCarModal">
    <div class="modal-content">
        <h2>ìƒˆ ì°¨ëŸ‰ ì¶”ê°€</h2>
        <div class="form-group">
            <label for="carName">ì°¨ëŸ‰ ì´ë¦„ (ëª¨ë¸ëª… ë˜ëŠ” ì• ì¹­)</label>
            <input type="text" id="carName" placeholder="ì˜ˆ: ì†Œë‚˜íƒ€, ìš°ë¦¬ì§‘ ì°¨" />
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="hideAddCarModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="addCar()">ì¶”ê°€</button>
        </div>
    </div>
</div>

<!-- ì£¼ì°¨ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ -->
<div class="modal" id="updateLocationModal">
    <div class="modal-content">
        <h2 id="updateModalTitle">ì£¼ì°¨ ìœ„ì¹˜ ì—…ë°ì´íŠ¸</h2>
        <div class="form-group">
            <label for="floor">ì£¼ì°¨ ì¸µ</label>
            <select id="floor">
                <option value="">ì¸µ ì„ íƒ</option>
                <option value="B5">ì§€í•˜ 5ì¸µ</option>
                <option value="B4">ì§€í•˜ 4ì¸µ</option>
                <option value="B3">ì§€í•˜ 3ì¸µ</option>
            </select>
        </div>
        <div class="form-group">
            <label for="section">êµ¬ì—­/ìœ„ì¹˜</label>
            <input type="text" id="section" placeholder="ì˜ˆ: A-15, ì—¬ì„±ì£¼ì°¨ì¥, ì „ê¸°ì°¨êµ¬ì—­, ì¶œêµ¬ ì•" />
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="hideUpdateModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="updateLocation()">ì—…ë°ì´íŠ¸</button>
        </div>
    </div>
</div>

<!-- ì•Œë¦¼ -->
<div class="notification" id="notification"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyDVoA4aRmhrwcDeU4qT9ZWBvLGdecYEwk4",
        authDomain: "car-parking-app-8aec7.firebaseapp.com",
        databaseURL: "https://car-parking-app-8aec7-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "car-parking-app-8aec7",
        storageBucket: "car-parking-app-8aec7.firebasestorage.app",
        messagingSenderId: "439284952071",
        appId: "1:439284952071:web:f101098f0c3ccf700f4ea2"
    };

    // ì „ì—­ ë³€ìˆ˜
    let database;
    let isOnline = false;
    let cars = [];
    let currentCarId = null;
    let notificationEnabled = false;
    let currentGroup = null;
    let userNickname = '';
    let lastDataUpdate = 0;
    const STORAGE_KEY = 'carParkingApp';

    // Firebase ì´ˆê¸°í™”
    function initFirebase() {
        console.log('ğŸ”„ Firebase ì´ˆê¸°í™” ì‹œë„...');
        
        if (typeof firebase === 'undefined') {
            console.error('âŒ Firebase SDK ë¡œë“œ ì‹¤íŒ¨');
            isOnline = false;
            updateConnectionStatus('offline');
            return;
        }
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('ğŸŸ¢ Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨');
                    isOnline = true;
                    updateConnectionStatus('online');
                    if (currentGroup) {
                        loadGroupData();
                    }
                } else {
                    console.log('ğŸŸ¡ Firebase ì—°ê²° ëŠê¹€');
                    isOnline = false;
                    updateConnectionStatus('offline');
                }
            });
            
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ!');
            
        } catch (error) {
            console.error('âŒ Firebase ì—°ê²° ì‹¤íŒ¨:', error);
            isOnline = false;
            updateConnectionStatus('offline');
        }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initFirebase, 500);
        checkExistingSession();
        scheduleNotifications();
        
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentGroup && isOnline) {
                console.log('ğŸ“± ì•±ì´ í¬ì»¤ìŠ¤ë¨ - ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
                loadGroupData();
            }
        });
    });

    // ê°•ì œ ìƒˆë¡œê³ ì¹¨
    function forceRefresh() {
        showNotification('ìƒˆë¡œê³ ì¹¨ ì¤‘...');
        setTimeout(() => {
            window.location.reload(true);
        }, 500);
    }

    // ìºì‹œ ì™„ì „ ì‚­ì œ
    async function clearCache() {
        if (confirm('ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ì–´ìš”?')) {
            try {
                const userData = localStorage.getItem(STORAGE_KEY);
                localStorage.clear();
                if (userData) {
                    localStorage.setItem(STORAGE_KEY, userData);
                }
                
                showNotification('ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
                
            } catch (error) {
                console.error('ìºì‹œ ì‚­ì œ ì‹¤íŒ¨:', error);
                showNotification('ìºì‹œ ì‚­ì œ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
            }
        }
    }

    // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
    function checkExistingSession() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            const parsed = JSON.parse(data);
            if (parsed.currentGroup && parsed.userNickname) {
                currentGroup = parsed.currentGroup;
                userNickname = parsed.userNickname;
                notificationEnabled = parsed.notificationEnabled || false;
                document.getElementById('notificationToggle').classList.toggle('active', notificationEnabled);
                
                showAppSection();
                
                if (isOnline) {
                    loadGroupData();
                } else {
                    cars = parsed.cars || [];
                    renderCarList();
                }
                return;
            }
        }
        showLoginSection();
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (status === 'online') {
            statusElement.innerHTML = 'ğŸŸ¢ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”';
            statusElement.className = 'connection-status status-connected';
        } else {
            statusElement.innerHTML = 'ğŸŸ¡ ë¡œì»¬ ëª¨ë“œ (ë™ê¸°í™” ë¶ˆê°€)';
            statusElement.className = 'connection-status status-local';
        }
    }

    // íƒ­ ì „í™˜
    function switchTab(tab) {
        const joinTab = document.querySelector('.login-tab:first-child');
        const createTab = document.querySelector('.login-tab:last-child');
        const joinForm = document.getElementById('joinForm');
        const createForm = document.getElementById('createForm');

        if (tab === 'join') {
            joinTab.classList.add('active');
            createTab.classList.remove('active');
            joinForm.style.display = 'block';
            createForm.style.display = 'none';
        } else {
            joinTab.classList.remove('active');
            createTab.classList.add('active');
            joinForm.style.display = 'none';
            createForm.style.display = 'block';
        }
    }

    // ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°
    async function createGroup() {
        const password = document.getElementById('createPassword').value.trim();
        const nickname = document.getElementById('createNickname').value.trim();

        if (!password || !nickname) {
            showNotification('ë¹„ë°€ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const groupCode = generateGroupCode();
        currentGroup = { code: groupCode, password: password };
        userNickname = nickname;

        if (isOnline) {
            try {
                await database.ref(`groups/${groupCode}`).set({
                    password: password,
                    createdAt: Date.now(),
                    cars: {},
                    members: {
                        [generateUserId()]: {
                            nickname: nickname,
                            joinedAt: Date.now()
                        }
                    }
                });
                showNotification('ìƒˆ ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                showNotification('ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
                return;
            }
        }

        saveLocalData();
        showAppSection();
    }

    // ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°
    async function joinGroup() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        const password = document.getElementById('joinPassword').value.trim();
        const nickname = document.getElementById('joinNickname').value.trim();

        if (!code || !password || !nickname) {
            showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        if (isOnline) {
            try {
                const groupSnapshot = await database.ref(`groups/${code}`).once('value');
                const groupData = groupSnapshot.val();

                if (!groupData) {
                    showNotification('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê·¸ë£¹ ì½”ë“œì…ë‹ˆë‹¤', 'error');
                    return;
                }

                if (groupData.password !== password) {
                    showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                const userId = generateUserId();
                await database.ref(`groups/${code}/members/${userId}`).set({
                    nickname: nickname,
                    joinedAt: Date.now()
                });

                showNotification(`${code} ê·¸ë£¹ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!`);
            } catch (error) {
                showNotification('ê·¸ë£¹ ì°¸ì—¬ ì‹¤íŒ¨: ' + error.message, 'error');
                return;
            }
        } else {
            showNotification('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ê·¸ë£¹ ì ‘ì†', 'error');
        }

        currentGroup = { code: code, password: password };
        userNickname = nickname;
        saveLocalData();
        showAppSection();
        
        if (isOnline) {
            loadGroupData();
        }
    }

    // ì•± ì„¹ì…˜ í‘œì‹œ
    function showAppSection() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
        document.getElementById('displayShareCode').textContent = currentGroup.code;
    }

    // ë¡œê·¸ì¸ ì„¹ì…˜ í‘œì‹œ
    function showLoginSection() {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('appSection').style.display = 'none';
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        if (confirm('ì •ë§ ê·¸ë£¹ì—ì„œ ë‚˜ê°€ì‹œê² ì–´ìš”?')) {
            currentGroup = null;
            userNickname = '';
            cars = [];
            localStorage.removeItem(STORAGE_KEY);
            showLoginSection();
            showNotification('ê·¸ë£¹ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤');
        }
    }

    // ê·¸ë£¹ ë°ì´í„° ë¡œë“œ
    function loadGroupData() {
        if (!isOnline || !currentGroup) return;

        const now = Date.now();
        if (now - lastDataUpdate < 1000) {
            console.log('â³ ë°ì´í„° ë¡œë“œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€');
            return;
        }
        lastDataUpdate = now;

        console.log('ğŸ“¡ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...');
        
        database.ref(`groups/${currentGroup.code}/cars`).off();
        database.ref(`groups/${currentGroup.code}/cars`).on('value', (snapshot) => {
            const data = snapshot.val();
            cars = data ? Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            })) : [];
            
            console.log('ğŸ“„ ë°ì´í„° ì—…ë°ì´íŠ¸:', cars.length, 'ê°œ ì°¨ëŸ‰');
            renderCarList();
            saveLocalData();
        });
    }

    // ë¡œì»¬ ë°ì´í„° ì €ì¥
    function saveLocalData() {
        const data = {
            currentGroup: currentGroup,
            userNickname: userNickname,
            notificationEnabled: notificationEnabled,
            cars: cars,
            lastSaved: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // ì˜¨ë¼ì¸ ë°ì´í„° ì €ì¥
    async function saveOnlineData() {
        if (!isOnline || !currentGroup) {
            saveLocalData();
            return;
        }

        try {
            const carsData = {};
            cars.forEach(car => {
                carsData[car.id] = {
                    name: car.name,
                    location: car.location,
                    lastUpdated: car.lastUpdated,
                    updatedBy: car.updatedBy
                };
            });

            await database.ref(`groups/${currentGroup.code}/cars`).set(carsData);
            console.log('ğŸ’¾ Firebase ì €ì¥ ì™„ë£Œ');
            saveLocalData();
        } catch (error) {
            console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
            showNotification('ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            saveLocalData();
        }
    }

    // ì°¨ëŸ‰ ëª©ë¡ ë Œë”ë§
    function renderCarList() {
        const carList = document.getElementById('carList');
        carList.innerHTML = '';

        if (cars.length === 0) {
            carList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸš—</div>
                    <div>ì•„ì§ ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ì–´ìš”</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">ìƒˆ ì°¨ëŸ‰ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                </div>
            `;
            return;
        }

        cars.forEach(car => {
            const timeAgo = car.lastUpdated ? getTimeAgo(car.lastUpdated) : null;
            
            const carCard = document.createElement('div');
            carCard.className = 'car-card';
            carCard.innerHTML = `
                <div class="car-header">
                    <div class="car-name">${car.name}</div>
                    <div class="car-status">${car.location ? 'ìœ„ì¹˜ ìˆìŒ' : 'ìœ„ì¹˜ ì—†ìŒ'}</div>
                </div>
                <div class="parking-info">
                    ${car.location ? 
                        `<div class="location-text">${car.location}</div>` + 
                        (timeAgo ? `<div class="update-time">${timeAgo} ì—…ë°ì´íŠ¸</div>` : '') +
                        (car.updatedBy ? `<div class="updated-by">by ${car.updatedBy}</div>` : '') :
                        '<div class="no-location">ì£¼ì°¨ ìœ„ì¹˜ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”</div>'
                    }
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showUpdateModal('${car.id}')">
                        ìœ„ì¹˜ ${car.location ? 'ìˆ˜ì •' : 'ë“±ë¡'}
                    </button>
                    <button class="btn btn-secondary" onclick="deleteCar('${car.id}')">
                        ì‚­ì œ
                    </button>
                </div>
            `;
            carList.appendChild(carCard);
        });
    }

    // ì‹œê°„ ê³„ì‚° ìœ í‹¸ë¦¬í‹°
    function getTimeAgo(timestamp) {
        const now = new Date();
        const updateTime = new Date(timestamp);
        const diffInMinutes = Math.floor((now - updateTime) / (1000 * 60));
        
        if (diffInMinutes < 1) return 'ë°©ê¸ˆ ì „';
        if (diffInMinutes < 60) return `${diffInMinutes}ë¶„ ì „`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}ì‹œê°„ ì „`;
        return `${Math.floor(diffInMinutes / 1440)}ì¼ ì „`;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function generateGroupCode() {
        return Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    function generateUserId() {
        return Math.random().toString(36).substr(2, 9);
    }

    // ì°¨ëŸ‰ ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddCarModal() {
        document.getElementById('addCarModal').style.display = 'block';
        document.getElementById('carName').focus();
    }

    // ì°¨ëŸ‰ ì¶”ê°€ ëª¨ë‹¬ ìˆ¨ê¹€
    function hideAddCarModal() {
        document.getElementById('addCarModal').style.display = 'none';
        document.getElementById('carName').value = '';
    }

    // ì°¨ëŸ‰ ì¶”ê°€
    function addCar() {
        const carName = document.getElementById('carName').value.trim();
        if (!carName) {
            showNotification('ì°¨ëŸ‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const newCar = {
            id: Date.now().toString(),
            name: carName,
            location: null,
            lastUpdated: null,
            updatedBy: null
        };

        cars.push(newCar);
        saveOnlineData();
        hideAddCarModal();
        showNotification('ì°¨ëŸ‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ í‘œì‹œ
    function showUpdateModal(carId) {
        currentCarId = carId;
        const car = cars.find(c => c.id === carId);
        if (!car) return;

        document.getElementById('updateModalTitle').textContent = `${car.name} ì£¼ì°¨ ìœ„ì¹˜`;
        document.getElementById('updateLocationModal').style.display = 'block';
        
        if (car.location) {
            const [floor, section] = car.location.split(' - ');
            document.getElementById('floor').value = floor || '';
            document.getElementById('section').value = section || '';
        }
    }

    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ìˆ¨ê¹€
    function hideUpdateModal() {
        document.getElementById('updateLocationModal').style.display = 'none';
        document.getElementById('floor').value = '';
        document.getElementById('section').value = '';
        currentCarId = null;
    }

    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    function updateLocation() {
        if (!currentCarId) return;

        const floor = document.getElementById('floor').value;
        const section = document.getElementById('section').value.trim();

        if (!floor || !section) {
            showNotification('ì¸µê³¼ êµ¬ì—­ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const car = cars.find(c => c.id === currentCarId);
        if (car) {
            car.location = `${floor} - ${section}`;
            car.lastUpdated = new Date().toISOString();
            car.updatedBy = userNickname;
            
            saveOnlineData();
            hideUpdateModal();
            showNotification('ì£¼ì°¨ ìœ„ì¹˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
    }

    // ì°¨ëŸ‰ ì‚­ì œ
    function deleteCar(carId) {
        if (confirm('ì •ë§ ì´ ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) {
            cars = cars.filter(c => c.id !== carId);
            saveOnlineData();
            showNotification('ì°¨ëŸ‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    }

    // ì•Œë¦¼ í† ê¸€
    function toggleNotification() {
        notificationEnabled = !notificationEnabled;
        document.getElementById('notificationToggle').classList.toggle('active', notificationEnabled);
        
        if (notificationEnabled) {
            if ('Notification' in window) {
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        showNotification('ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“±');
                        scheduleNotifications();
                    } else {
                        notificationEnabled = false;
                        document.getElementById('notificationToggle').classList.remove('active');
                        showNotification('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                    }
                    saveLocalData();
                });
            } else {
                showNotification('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                notificationEnabled = false;
                document.getElementById('notificationToggle').classList.remove('active');
            }
        } else {
            showNotification('ì•Œë¦¼ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        saveLocalData();
    }

    function scheduleNotifications() {
        if (!notificationEnabled) return;

        const now = new Date();
        const scheduledTime = new Date();
        scheduledTime.setHours(21, 0, 0, 0);

        if (now > scheduledTime) {
            scheduledTime.setDate(scheduledTime.getDate() + 1);
        }

        const timeUntilNotification = scheduledTime - now;

        setTimeout(() => {
            if (notificationEnabled && Notification.permission === 'granted') {
                new Notification('ğŸš— ì£¼ì°¨ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì•Œë¦¼', {
                    body: 'ì˜¤ëŠ˜ ì£¼ì°¨í•œ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”!',
                    vibrate: [200, 100, 200],
                    tag: 'parking-reminder'
                });
            }
            
            setTimeout(scheduleNotifications, 24 * 60 * 60 * 1000);
        }, timeUntilNotification);
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    window.addEventListener('click', function(event) {
        const addModal = document.getElementById('addCarModal');
        const updateModal = document.getElementById('updateLocationModal');
        
        if (event.target === addModal) {
            hideAddCarModal();
        }
        if (event.target === updateModal) {
            hideUpdateModal();
        }
    });

    document.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            const addModal = document.getElementById('addCarModal');
            const updateModal = document.getElementById('updateLocationModal');
            
            if (addModal.style.display === 'block') {
                addCar();
            } else if (updateModal.style.display === 'block') {
                updateLocation();
            }
        }
    });

    // ìë™ ëŒ€ë¬¸ì ë³€í™˜
    document.getElementById('joinCode').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
</script>
```

</body>
</html>
